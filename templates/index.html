<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Server{% if current_path %} - {{ current_path }}{% endif %}</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --hover-color: #e9ecef;
            --accent-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        [data-theme="dark"] {
            --bg-primary: #212529;
            --bg-secondary: #343a40;
            --bg-tertiary: #495057;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --hover-color: #495057;
            --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(-45deg, #e9ecef, #dee2e6, #ced4da, #adb5bd);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: var(--text-primary);
            line-height: 1.5;
            transition: color 0.3s;
            min-height: 100vh;
        }
        
        [data-theme="dark"] body {
            background: linear-gradient(-45deg, #0d1117, #0c1419, #0a0e1a, #1c1f26);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        
        .btn {
            background: rgba(13, 110, 253, 0.7);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            transition: all 0.2s;
            font-size: 0.8125rem;
            white-space: nowrap;
            min-height: 2rem;
            box-sizing: border-box;
        }
        
        .btn:hover {
            background: rgba(13, 110, 253, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-secondary {
            background: rgba(233, 236, 239, 0.7);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            border: 1px solid rgba(222, 226, 230, 0.3);
        }
        
        [data-theme="dark"] .btn-secondary {
            background: rgba(73, 80, 87, 0.7);
            border: 1px solid rgba(108, 117, 125, 0.3);
        }
        
        .btn-danger {
            background: var(--danger-color);
        }
        
        .btn-success {
            background: rgba(25, 135, 84, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .theme-toggle {
            background: rgba(248, 249, 250, 0.3);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(222, 226, 230, 0.2);
            color: var(--text-primary);
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 2rem;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        
        [data-theme="dark"] .theme-toggle {
            background: rgba(52, 58, 64, 0.3);
            border: 1px solid rgba(73, 80, 87, 0.2);
        }
        
        .theme-toggle:hover {
            background: rgba(248, 249, 250, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] .theme-toggle:hover {
            background: rgba(52, 58, 64, 0.5);
        }
        
        .main-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .breadcrumb-toolbar {
            margin-bottom: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: rgba(248, 249, 250, 0.4);
            backdrop-filter: blur(20px);
            border-radius: 0.375rem;
            border: 1px solid rgba(222, 226, 230, 0.15);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        [data-theme="dark"] .breadcrumb-toolbar {
            background: rgba(52, 58, 64, 0.4);
            border: 1px solid rgba(73, 80, 87, 0.15);
        }
        
        .toolbar-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .action-buttons {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .breadcrumb a {
            color: var(--accent-color);
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        
        .breadcrumb a:hover {
            background: rgba(233, 236, 239, 0.3);
            backdrop-filter: blur(5px);
        }
        
        [data-theme="dark"] .breadcrumb a:hover {
            background: rgba(73, 80, 87, 0.3);
        }
        
        .breadcrumb .separator {
            margin: 0 0.5rem;
            color: var(--text-secondary);
        }
        
        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .sort-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .sort-controls select {
            background: rgba(248, 249, 250, 0.3);
            backdrop-filter: blur(15px);
            color: var(--text-primary);
            border: 1px solid rgba(222, 226, 230, 0.2);
            border-radius: 0.375rem;
            padding: 0.375rem 0.5rem;
            min-height: 2rem;
            box-sizing: border-box;
        }
        
        [data-theme="dark"] .sort-controls select {
            background: rgba(52, 58, 64, 0.3);
            border: 1px solid rgba(73, 80, 87, 0.2);
        }
        
        .file-list {
            background: rgba(248, 249, 250, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(222, 226, 230, 0.15);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        [data-theme="dark"] .file-list {
            background: rgba(52, 58, 64, 0.4);
            border: 1px solid rgba(73, 80, 87, 0.15);
        }
        
        .file-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            align-items: center;
            padding: 0.375rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            gap: 0.75rem;
        }
        
        .file-item:hover {
            background: rgba(233, 236, 239, 0.3);
            backdrop-filter: blur(10px);
        }
        
        [data-theme="dark"] .file-item:hover {
            background: rgba(73, 80, 87, 0.3);
        }
        
        
        .file-icon {
            font-size: 1.5rem;
            width: 2rem;
            text-align: center;
        }
        
        .file-icon.folder {
            color: #ffc107;
        }
        
        .file-icon.image {
            color: #28a745;
        }
        
        .file-icon.video {
            color: #dc3545;
        }
        
        .file-icon.audio {
            color: #6f42c1;
        }
        
        .file-icon.document {
            color: #007bff;
        }
        
        .file-info {
            min-width: 0;
        }
        
        .file-name {
            font-weight: 500;
            word-break: break-word;
            margin-bottom: 0.25rem;
        }
        
        .file-meta {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .file-size, .file-date, .file-actions {
            color: var(--text-secondary);
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .file-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .file-item:hover .file-actions {
            opacity: 1;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: rgba(233, 236, 239, 0.4);
            backdrop-filter: blur(8px);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .action-btn:hover {
            background: rgba(73, 80, 87, 0.4);
        }
        
        .search-box {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(222, 226, 230, 0.2);
            border-radius: 0.375rem;
            padding: 0.5rem;
            min-width: 200px;
        }
        
        [data-theme="dark"] .search-box {
            background: rgba(33, 37, 41, 0.3);
            border: 1px solid rgba(73, 80, 87, 0.2);
        }
        
        .search-box input {
            border: none;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            color: var(--text-primary);
            outline: none;
            flex: 1;
            margin-left: 0.5rem;
        }
        
        [data-theme="dark"] .search-box input {
            background: rgba(33, 37, 41, 0.2);
        }
        
        body.dragover::before {
            content: "Drop files anywhere to upload";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 110, 253, 0.9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            z-index: 10000;
            pointer-events: none;
        }
        
        .context-menu {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
            display: none;
        }
        
        .context-menu-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-item:hover {
            background: rgba(233, 236, 239, 0.4);
            backdrop-filter: blur(8px);
        }
        
        [data-theme="dark"] .context-menu-item:hover {
            background: rgba(73, 80, 87, 0.4);
        }
        
        .context-menu-item.danger:hover {
            background: var(--danger-color);
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 0.5rem;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175);
            width: 500px;
            border: 1px solid rgba(222, 226, 230, 0.2);
        }
        
        [data-theme="dark"] .modal-content {
            background: rgba(33, 37, 41, 0.8);
            border: 1px solid rgba(73, 80, 87, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(222, 226, 230, 0.3);
            border-radius: 0.375rem;
            background: rgba(248, 249, 250, 0.6);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .form-control {
            background: rgba(52, 58, 64, 0.6);
            border: 1px solid rgba(73, 80, 87, 0.3);
        }
        
        .progress-container {
            margin-top: 1rem;
            display: none;
        }
        
        .progress-bar {
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            height: 1rem;
            overflow: hidden;
        }
        
        .progress-fill {
            background: var(--accent-color);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .download-queue {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            max-width: 300px;
            box-shadow: var(--shadow);
            display: none;
        }
        
        .download-queue.show {
            display: block;
        }
        
        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .queue-item:last-child {
            border-bottom: none;
        }
        
        .shared-text-area {
            background: rgba(248, 249, 250, 0.25);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(222, 226, 230, 0.1);
            border-radius: 0.5rem;
            margin-top: 1rem;
            overflow: hidden;
        }
        
        [data-theme="dark"] .shared-text-area {
            background: rgba(52, 58, 64, 0.25);
            border: 1px solid rgba(73, 80, 87, 0.1);
        }
        
        .shared-text-header {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(222, 226, 230, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(248, 249, 250, 0.1);
            backdrop-filter: blur(5px);
        }
        
        [data-theme="dark"] .shared-text-header {
            border-bottom: 1px solid rgba(73, 80, 87, 0.2);
            background: rgba(52, 58, 64, 0.1);
        }
        
        .shared-text-content {
            height: 180px;
            resize: none;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            color: var(--text-primary);
            padding: 0.5rem;
            width: 100%;
            font-family: inherit;
        }
        
        [data-theme="dark"] .shared-text-content {
            background: rgba(33, 37, 41, 0.15);
        }
        
        .text-formatting {
            padding: 0.375rem 0.75rem;
            display: flex;
            gap: 0.375rem;
            flex-wrap: wrap;
        }
        
        .format-btn {
            background: rgba(233, 236, 239, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(222, 226, 230, 0.3);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        [data-theme="dark"] .format-btn {
            background: rgba(73, 80, 87, 0.5);
            border: 1px solid rgba(108, 117, 125, 0.3);
        }
        
        .format-btn:hover {
            background: rgba(233, 236, 239, 0.7);
            transform: translateY(-1px);
        }
        
        [data-theme="dark"] .format-btn:hover {
            background: rgba(73, 80, 87, 0.7);
        }
        
        .alert {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
        }
        
        .alert-success {
            background: rgba(25, 135, 84, 0.1);
            border-color: var(--success-color);
            color: var(--success-color);
        }
        
        .alert-error {
            background: rgba(220, 53, 69, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        
        .alert-info {
            background: rgba(13, 110, 253, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .loading-spinner {
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .breadcrumb-toolbar {
                padding: 0.375rem 0.5rem;
            }
            
            .toolbar-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.375rem;
            }
            
            .action-buttons {
                justify-content: center;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 0.25rem;
            }
            
            .action-buttons .btn,
            .action-buttons .theme-toggle {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
                min-height: 1.75rem;
                flex-shrink: 0;
            }
            
            .sort-controls {
                justify-content: center;
                gap: 0.25rem;
            }
            
            .sort-controls select {
                min-height: 1.75rem;
                font-size: 0.75rem;
            }
            
            .search-box {
                min-width: auto;
                flex: 1;
            }
            
            .file-item {
                grid-template-columns: auto 1fr auto;
                gap: 0.5rem;
            }
            
            .file-size, .file-date {
                display: none;
            }
            
            .modal-content {
                width: 90vw;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>

    <div class="main-content">
        <!-- Combined Breadcrumb and Toolbar -->
        <div class="breadcrumb-toolbar">
            <!-- First row: Breadcrumb and Search -->
            <div class="toolbar-row">
                <div class="breadcrumb">
                    <a href="{{ url_for('index') }}">
                        <i class="fas fa-home"></i>
                        Home
                    </a>
                    {% for crumb in breadcrumbs %}
                        <span class="separator">/</span>
                        <a href="{{ url_for('index', path=crumb.path) }}">{{ crumb.name }}</a>
                    {% endfor %}
                </div>
                
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search files..." value="{{ search_query }}">
                </div>
            </div>
            
            <!-- Second row: Action buttons and Sort -->
            <div class="toolbar-row">
                <div class="action-buttons">
                    <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <button class="btn btn-success" id="uploadBtn">
                        <i class="fas fa-upload"></i>
                        Upload
                    </button>
                    
                    {% if is_admin %}
                        <button class="btn btn-success" id="createFolderBtn">
                            <i class="fas fa-folder-plus"></i>
                            New Folder
                        </button>
                        
                        <button class="btn btn-secondary" id="undoBtn">
                            <i class="fas fa-undo"></i>
                            Undo
                        </button>
                        
                        <a href="{{ url_for('logout') }}" class="btn btn-secondary">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </a>
                    {% else %}
                        <a href="{{ url_for('login') }}" class="btn">
                            <i class="fas fa-sign-in-alt"></i>
                            Admin Login
                        </a>
                    {% endif %}
                </div>
                
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select id="sortSelect">
                        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name</option>
                        <option value="size" {% if sort_by == 'size' %}selected{% endif %}>Size</option>
                        <option value="modified" {% if sort_by == 'modified' %}selected{% endif %}>Modified</option>
                    </select>
                    
                    <button class="btn btn-secondary" id="sortOrderBtn" data-order="{{ order }}">
                        <i class="fas fa-sort-{{ 'up' if order == 'asc' else 'down' }}"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div id="alertContainer"></div>

        <!-- Hidden File Input -->
        <input type="file" id="fileInput" multiple style="display: none;">
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Uploading...</div>
        </div>

        <!-- File List -->
        <div class="file-list">
            {% if not items %}
                <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                    <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>This directory is empty</p>
                </div>
            {% endif %}
            
            {% for item in items %}
            <div class="file-item" data-path="{{ item.path }}" data-is-dir="{{ item.is_dir|lower }}">
                <div class="file-icon {{ 'folder' if item.is_dir else 'file' }}">
                    <i class="{{ item.icon }}"></i>
                </div>
                
                <div class="file-info">
                    <div class="file-name">{{ item.name }}</div>
                </div>
                
                <div class="file-size">{{ item.size_formatted }}</div>
                <div class="file-date">{{ item.modified }}</div>
                
                <div class="file-actions">
                    {% if item.is_dir %}
                        <button class="action-btn" title="Download as ZIP" onclick="downloadFolder('{{ item.path }}')">
                            <i class="fas fa-download"></i>
                        </button>
                    {% else %}
                        <button class="action-btn" title="Preview" onclick="previewFile('{{ item.path }}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn" title="Download" onclick="downloadFile('{{ item.path }}')">
                            <i class="fas fa-download"></i>
                        </button>
                    {% endif %}
                    
                    {% if is_admin %}
                        <button class="action-btn" title="Rename" onclick="renameItem('{{ item.path }}', '{{ item.name }}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" title="Delete" onclick="deleteItem('{{ item.path }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Shared Text Area -->
        <div class="shared-text-area">
            <div class="shared-text-header">
                <h3>
                    <i class="fas fa-comments"></i>
                    Clipboard
                </h3>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    
                    <button class="btn btn-secondary" id="copyTextBtn" title="Copy to clipboard">
                        <i class="fas fa-copy"></i>
                        Copy
                    </button>
                </div>
            </div>
            
            <textarea class="shared-text-content" id="sharedTextArea"></textarea>
            
            <div class="text-formatting">
                <button class="format-btn" onclick="formatText('upper')">UPPER</button>
                <button class="format-btn" onclick="formatText('lower')">lower</button>
                <button class="format-btn" onclick="formatText('title')">Title Case</button>
                <button class="format-btn" onclick="formatText('clear')">Clear</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextPreview()">
            <i class="fas fa-eye"></i>
            Preview
        </div>
        <div class="context-menu-item" onclick="contextDownload()">
            <i class="fas fa-download"></i>
            Download
        </div>
        {% if is_admin %}
        <div class="context-menu-item" onclick="contextRename()">
            <i class="fas fa-edit"></i>
            Rename
        </div>
        <div class="context-menu-item danger" onclick="contextDelete()">
            <i class="fas fa-trash"></i>
            Delete
        </div>
        {% endif %}
    </div>

    <!-- Download Queue -->
    <div class="download-queue" id="downloadQueue">
        <div class="queue-header">
            <h4>Download Queue</h4>
            <button class="close-btn" onclick="hideDownloadQueue()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="queueItems"></div>
    </div>

    <!-- Modals -->
    
    <!-- Create Folder Modal -->
    <div class="modal" id="createFolderModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Folder</div>
                <button class="close-btn" onclick="closeModal('createFolderModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="createFolderForm">
                <div class="form-group">
                    <label class="form-label">Folder Name</label>
                    <input type="text" class="form-control" id="folderNameInput" placeholder="Enter folder name" required>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createFolderModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Rename Item</div>
                <button class="close-btn" onclick="closeModal('renameModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="renameForm">
                <div class="form-group">
                    <label class="form-label">New Name</label>
                    <input type="text" class="form-control" id="renameInput" required>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('renameModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Rename</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal" id="previewModal">
        <div class="modal-content" style="width: 80vw; height: 80vh;">
            <div class="modal-header">
                <div class="modal-title" id="previewTitle">File Preview</div>
                <button class="close-btn" onclick="closeModal('previewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="previewContent" style="height: calc(100% - 4rem); overflow: auto;">
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading-spinner"></div>
                    <p>Loading preview...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let currentPath = '{{ current_path }}';
        let contextMenuItem = null;
        let downloadQueue = [];
        let sharedTextTimeout = null;
        
        // Initialize Socket.IO
        document.addEventListener('DOMContentLoaded', function() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
            });
            
            socket.on('file_updated', function(data) {
                if (data.path === currentPath) {
                    location.reload();
                }
            });
            
            socket.on('shared_text_updated', function(data) {
                const textarea = document.getElementById('sharedTextArea');
                if (document.activeElement !== textarea) {
                    textarea.value = data.content;
                }
            });
            
            initializeTheme();
            initializeFileHandling();
            initializeSharedText();
            initializeSearch();
            initializeSorting();
        });
        
        // Theme handling
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            setTheme(theme);
            
            themeToggle.addEventListener('click', toggleTheme);
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.querySelector('#themeToggle i');
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', theme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }
        
        // File handling
        function initializeFileHandling() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            
            // Upload button click handler
            if (uploadBtn && fileInput) {
                uploadBtn.addEventListener('click', () => fileInput.click());
            }
            
            // Whole page drag and drop
            document.addEventListener('dragover', handlePageDragOver);
            document.addEventListener('dragleave', handlePageDragLeave);
            document.addEventListener('drop', handlePageDrop);
            
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            // File item click handlers
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', handleFileClick);
                item.addEventListener('contextmenu', handleContextMenu);
            });
            
            // Modal handlers
            const createFolderBtn = document.getElementById('createFolderBtn');
            if (createFolderBtn) {
                createFolderBtn.addEventListener('click', () => showModal('createFolderModal'));
            }
            
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) {
                undoBtn.addEventListener('click', undoLastAction);
            }
            
            // Form handlers
            const createFolderForm = document.getElementById('createFolderForm');
            if (createFolderForm) {
                createFolderForm.addEventListener('submit', handleCreateFolder);
            }
            
            const renameForm = document.getElementById('renameForm');
            if (renameForm) {
                renameForm.addEventListener('submit', handleRename);
            }
            
            // Hide context menu on click outside
            document.addEventListener('click', hideContextMenu);
        }
        
        function handlePageDragOver(e) {
            e.preventDefault();
            document.body.classList.add('dragover');
        }
        
        function handlePageDragLeave(e) {
            e.preventDefault();
            // Only remove dragover class if we're leaving the document body
            if (!e.relatedTarget || e.relatedTarget.nodeName === 'HTML') {
                document.body.classList.remove('dragover');
            }
        }
        
        function handlePageDrop(e) {
            e.preventDefault();
            document.body.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                const files = Array.from(e.dataTransfer.files);
                uploadFiles(files);
            }
        }
        
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            uploadFiles(files);
        }
        
        function uploadFiles(files) {
            if (files.length === 0) return;
            
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));
            formData.append('path', currentPath);
            
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Uploading...';
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressFill.style.width = percentComplete + '%';
                    progressText.textContent = `Uploading... ${Math.round(percentComplete)}%`;
                }
            });
            
            xhr.addEventListener('load', () => {
                progressContainer.style.display = 'none';
                
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    showAlert('Files uploaded successfully!', 'success');
                    // File list will be updated via socket
                } else {
                    const error = JSON.parse(xhr.responseText);
                    showAlert(error.error || 'Upload failed', 'error');
                }
            });
            
            xhr.addEventListener('error', () => {
                progressContainer.style.display = 'none';
                showAlert('Upload failed', 'error');
            });
            
            xhr.open('POST', '/upload');
            xhr.send(formData);
        }
        
        function handleFileClick(e) {
            if (e.target.closest('.file-actions')) return;
            
            const item = e.currentTarget;
            const path = item.dataset.path;
            const isDir = item.dataset.isDir === 'true';
            
            if (isDir) {
                window.location.href = `/?path=${encodeURIComponent(path)}`;
            }
        }
        
        function handleContextMenu(e) {
            e.preventDefault();
            
            const item = e.currentTarget;
            const path = item.dataset.path;
            const isDir = item.dataset.isDir === 'true';
            
            contextMenuItem = { path, isDir };
            
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
        }
        
        function hideContextMenu() {
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'none';
        }
        
        function contextPreview() {
            if (contextMenuItem) {
                previewFile(contextMenuItem.path);
            }
            hideContextMenu();
        }
        
        function contextDownload() {
            if (contextMenuItem) {
                if (contextMenuItem.isDir) {
                    downloadFolder(contextMenuItem.path);
                } else {
                    downloadFile(contextMenuItem.path);
                }
            }
            hideContextMenu();
        }
        
        function contextRename() {
            if (contextMenuItem) {
                const fileName = contextMenuItem.path.split('/').pop();
                renameItem(contextMenuItem.path, fileName);
            }
            hideContextMenu();
        }
        
        function contextDelete() {
            if (contextMenuItem) {
                deleteItem(contextMenuItem.path);
            }
            hideContextMenu();
        }
        
        // File operations
        function downloadFile(path) {
            addToDownloadQueue(path, 'file');
            window.open(`/download?path=${encodeURIComponent(path)}`, '_blank');
        }
        
        function downloadFolder(path) {
            addToDownloadQueue(path, 'folder');
            window.open(`/download_folder?path=${encodeURIComponent(path)}`, '_blank');
        }
        
        function previewFile(path) {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const content = document.getElementById('previewContent');
            
            const fileName = path.split('/').pop();
            title.textContent = `Preview: ${fileName}`;
            
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading-spinner"></div>
                    <p>Loading preview...</p>
                </div>
            `;
            
            showModal('previewModal');
            
            // Check file type and create appropriate preview
            const ext = fileName.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'];
            const videoExts = ['mp4', 'avi', 'mkv', 'mov', 'wmv', 'webm'];
            const audioExts = ['mp3', 'wav', 'flac', 'aac', 'ogg', 'm4a'];
            
            if (imageExts.includes(ext)) {
                content.innerHTML = `
                    <div style="text-align: center;">
                        <img src="/download?path=${encodeURIComponent(path)}" style="max-width: 100%; max-height: 400px; border-radius: 0.375rem;" alt="${fileName}">
                    </div>
                `;
            } else if (videoExts.includes(ext)) {
                content.innerHTML = `
                    <div style="text-align: center;">
                        <video controls style="max-width: 100%; max-height: 400px; border-radius: 0.375rem;">
                            <source src="/download?path=${encodeURIComponent(path)}" type="video/${ext}">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                `;
            } else if (audioExts.includes(ext)) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-music" style="font-size: 4rem; margin-bottom: 1rem; color: var(--accent-color);"></i>
                        <h3>${fileName}</h3>
                        <audio controls style="width: 100%; margin-top: 1rem;">
                            <source src="/download?path=${encodeURIComponent(path)}" type="audio/${ext}">
                            Your browser does not support the audio tag.
                        </audio>
                    </div>
                `;
            } else {
                // Try to preview as text
                fetch(`/preview?path=${encodeURIComponent(path)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            content.innerHTML = `
                                <pre style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.375rem; overflow: auto; white-space: pre-wrap; font-family: 'Courier New', monospace;">${escapeHtml(data.content)}</pre>
                            `;
                        } else {
                            content.innerHTML = `
                                <div style="text-align: center; padding: 2rem;">
                                    <i class="fas fa-file" style="font-size: 4rem; margin-bottom: 1rem; color: var(--text-secondary);"></i>
                                    <p>Preview not available for this file type</p>
                                    <button class="btn" onclick="downloadFile('${path}')">
                                        <i class="fas fa-download"></i>
                                        Download File
                                    </button>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 2rem;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 4rem; margin-bottom: 1rem; color: var(--warning-color);"></i>
                                <p>Error loading preview</p>
                            </div>
                        `;
                    });
            }
        }
        
        function renameItem(path, currentName) {
            const modal = document.getElementById('renameModal');
            const input = document.getElementById('renameInput');
            
            input.value = currentName;
            input.dataset.path = path;
            
            showModal('renameModal');
            setTimeout(() => input.focus(), 100);
        }
        
        function deleteItem(path) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            fetch('/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ path })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Item deleted successfully', 'success');
                } else {
                    showAlert(data.error || 'Delete failed', 'error');
                }
            })
            .catch(error => {
                showAlert('Delete failed', 'error');
            });
        }
        
        function handleCreateFolder(e) {
            e.preventDefault();
            
            const folderName = document.getElementById('folderNameInput').value.trim();
            if (!folderName) return;
            
            fetch('/create_folder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    path: currentPath,
                    name: folderName 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Folder created successfully', 'success');
                    closeModal('createFolderModal');
                    document.getElementById('folderNameInput').value = '';
                } else {
                    showAlert(data.error || 'Failed to create folder', 'error');
                }
            })
            .catch(error => {
                showAlert('Failed to create folder', 'error');
            });
        }
        
        function handleRename(e) {
            e.preventDefault();
            
            const input = document.getElementById('renameInput');
            const newName = input.value.trim();
            const path = input.dataset.path;
            
            if (!newName) return;
            
            fetch('/rename', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    path: path,
                    name: newName 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Item renamed successfully', 'success');
                    closeModal('renameModal');
                } else {
                    showAlert(data.error || 'Failed to rename item', 'error');
                }
            })
            .catch(error => {
                showAlert('Failed to rename item', 'error');
            });
        }
        
        function undoLastAction() {
            if (!confirm('Undo the last action?')) return;
            
            fetch('/undo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Action undone successfully', 'success');
                } else {
                    showAlert(data.error || 'Failed to undo action', 'error');
                }
            })
            .catch(error => {
                showAlert('Failed to undo action', 'error');
            });
        }
        
        // Download queue
        function addToDownloadQueue(path, type) {
            const fileName = path.split('/').pop() || 'files';
            const item = {
                id: Date.now(),
                path: path,
                name: fileName,
                type: type,
                status: 'downloading'
            };
            
            downloadQueue.push(item);
            updateDownloadQueue();
            showDownloadQueue();
            
            // Simulate download completion
            setTimeout(() => {
                item.status = 'completed';
                updateDownloadQueue();
                
                setTimeout(() => {
                    removeFromDownloadQueue(item.id);
                }, 3000);
            }, 2000);
        }
        
        function removeFromDownloadQueue(id) {
            downloadQueue = downloadQueue.filter(item => item.id !== id);
            updateDownloadQueue();
            
            if (downloadQueue.length === 0) {
                hideDownloadQueue();
            }
        }
        
        function updateDownloadQueue() {
            const queueItems = document.getElementById('queueItems');
            
            queueItems.innerHTML = downloadQueue.map(item => `
                <div class="queue-item">
                    <div>
                        <i class="fas fa-${item.type === 'folder' ? 'folder' : 'file'}"></i>
                        ${item.name}
                    </div>
                    <div>
                        ${item.status === 'downloading' ? 
                            '<div class="loading-spinner"></div>' : 
                            '<i class="fas fa-check" style="color: var(--success-color);"></i>'
                        }
                    </div>
                </div>
            `).join('');
        }
        
        function showDownloadQueue() {
            document.getElementById('downloadQueue').classList.add('show');
        }
        
        function hideDownloadQueue() {
            document.getElementById('downloadQueue').classList.remove('show');
        }
        
        // Shared text area
        function initializeSharedText() {
            const textarea = document.getElementById('sharedTextArea');
            const copyBtn = document.getElementById('copyTextBtn');
            
            // Load initial content
            fetch('/shared_text')
                .then(response => response.json())
                .then(data => {
                    textarea.value = data.content;
                })
                .catch(error => {
                    console.error('Failed to load shared text:', error);
                });
            
            // Handle text changes
            textarea.addEventListener('input', () => {
                clearTimeout(sharedTextTimeout);
                sharedTextTimeout = setTimeout(() => {
                    updateSharedText(textarea.value);
                }, 500);
            });
            
            // Handle copy button
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    copyToClipboard(textarea.value);
                });
            }
        }
        
        function updateSharedText(content) {
            fetch('/shared_text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content })
            })
            .catch(error => {
                console.error('Failed to update shared text:', error);
            });
        }
        
        function formatText(type) {
            const textarea = document.getElementById('sharedTextArea');
            let content = textarea.value;
            
            switch (type) {
                case 'upper':
                    content = content.toUpperCase();
                    break;
                case 'lower':
                    content = content.toLowerCase();
                    break;
                case 'title':
                    content = content.replace(/\w\S*/g, (txt) => 
                        txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
                    );
                    break;
                case 'clear':
                    content = '';
                    break;
            }
            
            textarea.value = content;
            // Immediately update shared text to sync with other clients
            updateSharedText(content);
            textarea.focus();
        }
        
        // Search functionality
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = searchInput.value.trim();
                    const url = new URL(window.location);
                    
                    if (query) {
                        url.searchParams.set('search', query);
                    } else {
                        url.searchParams.delete('search');
                    }
                    
                    window.location.href = url.toString();
                }, 300);
            });
        }
        
        // Sorting functionality
        function initializeSorting() {
            const sortSelect = document.getElementById('sortSelect');
            const sortOrderBtn = document.getElementById('sortOrderBtn');
            
            if (sortSelect) {
                sortSelect.addEventListener('change', () => {
                    updateSort();
                });
            }
            
            if (sortOrderBtn) {
                sortOrderBtn.addEventListener('click', () => {
                    const currentOrder = sortOrderBtn.dataset.order;
                    const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                    sortOrderBtn.dataset.order = newOrder;
                    
                    const icon = sortOrderBtn.querySelector('i');
                    icon.className = `fas fa-sort-${newOrder === 'asc' ? 'up' : 'down'}`;
                    
                    updateSort();
                });
            }
        }
        
        function updateSort() {
            const sortSelect = document.getElementById('sortSelect');
            const sortOrderBtn = document.getElementById('sortOrderBtn');
            
            const url = new URL(window.location);
            url.searchParams.set('sort', sortSelect.value);
            url.searchParams.set('order', sortOrderBtn.dataset.order);
            
            window.location.href = url.toString();
        }
        
        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            
            // Stop any audio/video that might be playing in the modal
            if (modalId === 'previewModal') {
                const audioElements = modal.querySelectorAll('audio');
                const videoElements = modal.querySelectorAll('video');
                
                audioElements.forEach(audio => {
                    audio.pause();
                    audio.currentTime = 0;
                });
                
                videoElements.forEach(video => {
                    video.pause();
                    video.currentTime = 0;
                });
            }
            
            modal.classList.remove('show');
        }
        
        // Alert functions
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div class="alert alert-${type}" id="${alertId}">
                    <i class="fas fa-${getAlertIcon(type)}"></i>
                    ${message}
                    <button class="close-btn" onclick="closeAlert('${alertId}')" style="margin-left: auto;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                closeAlert(alertId);
            }, 5000);
        }
        
        function getAlertIcon(type) {
            switch (type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-triangle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        function closeAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.opacity = '0';
                alert.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    alert.remove();
                }, 300);
            }
        }
        
        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function copyToClipboard(text) {
            // Check if modern clipboard API is available
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert('Text copied to clipboard!', 'success');
                }).catch(err => {
                    // Fallback if modern API fails
                    copyToClipboardFallback(text);
                });
            } else {
                // Use fallback method
                copyToClipboardFallback(text);
            }
        }
        
        function copyToClipboardFallback(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            textarea.style.top = '-999999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('Text copied to clipboard!', 'success');
                } else {
                    showAlert('Failed to copy text', 'error');
                }
            } catch (err) {
                showAlert('Copy not supported in this browser', 'error');
            }
            
            document.body.removeChild(textarea);
        }
        
        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                const modalId = e.target.id;
                closeModal(modalId);
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape key closes modals and context menu
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    closeModal(modal.id);
                });
                hideContextMenu();
            }
            
            // Ctrl+U for upload (admin only)
            if (e.ctrlKey && e.key === 'u' && document.getElementById('fileInput')) {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
            
            // Ctrl+N for new folder (admin only)
            if (e.ctrlKey && e.key === 'n' && document.getElementById('createFolderBtn')) {
                e.preventDefault();
                showModal('createFolderModal');
            }
        });
    </script>
</body>
</html>